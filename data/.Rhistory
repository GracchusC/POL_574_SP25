#panel$country_product <- as.factor(paste(panel$iso3c, panel$product_hs))
total_imports <- panel %>%
group_by(iso3c, year) %>%
summarize(total_annual_imports = sum(import_value_hs6, na.rm=T)) %>%
ungroup()
panel <- merge(panel, total_imports)
panel$import_share <- panel$import_value_hs6 / panel$total_annual_imports
panel$import_share_ln <- log(panel$import_share)
panel <- panel %>%
group_by(iso3c_product) %>%
mutate(global_market_share_l1 = lag(global_market_share_hs6, order_by=year, n=1),
coi_l1 = lag(coi_hs6, order_by=year, n=1),
eci_l1 = lag(eci_hs6, order_by=year, n=1),
pci_l1 = lag(pci_hs4, order_by=year, n=1),
elasticity_l1 = lag(elasticity, order_by=year, n=1),
belowinvstgrade_any_l1 = lag(belowinvstgrade_any, order_by=year, n=1),
belowinvstgrade_all_l1 = lag(belowinvstgrade_all, order_by=year, n=1),
import_share_ln_l1 = lag(import_share_ln, order_by=year, n=1)) %>%
ungroup()
panel$import_share_ln_l1[is.infinite(panel$import_share_ln_l1)] <- NA
median_gdp <- panel %>%
group_by(year) %>%
summarize(median_gdppc_const2015usd_ln = median(gdppc_const2015usd_ln, na.rm=T))
panel <- merge(panel, median_gdp, by="year")
panel$below_median_gdp <- panel$gdppc_const2015usd_ln < panel$median_gdppc_const2015usd_ln
panel$global_market_share_ln_l1 <- log(panel$global_market_share_l1)
panel$global_market_share_ln_l1[is.infinite(panel$global_market_share_ln_l1)] <- NA
hist(panel$global_market_share_ln_l1)
panel$mfn_rate_l1_winsor <- DescTools::Winsorize(panel$mfn_rate_l1, quantile(panel$mfn_rate_l1, probs=c(0.05, 0.95), na.rm=T))
panel$mfn_rate_winsor <- DescTools::Winsorize(panel$mfn_rate, quantile(panel$mfn_rate, probs=c(0.05, 0.95), na.rm=T))
panel$reer1_l1_winsor <- DescTools::Winsorize(panel$reer1_l1, quantile(panel$reer1_l1, probs=c(0.05, 0.95), na.rm=T))
#panel$overhang_winsor <- DescTools::Winsorize(panel$overhang, quantile(panel$overhang, probs=c(0.05, 0.95), na.rm=T))
#table(is.na(panel$gdp_const2015usd_ln), panel$year)
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc, na.rm=T),
population_ln = mean(population_ln, na.rm=T))
rm(list = ls())
options(scipen=999)
pacman::p_load(tidyverse, fixest, marginaleffects)
setwd("/Users/christianbaehr/Dropbox/Tariffs/")
panel <- read.csv("Data/Processed/panel_pcy.csv", stringsAsFactors = F)
#haven::write_dta(panel, "Data/Processed/panel_pcy.dta")
# panel %>%
#   group_by(iso3c_product) %>%
#   summarize(num = n()) %>%
#   ggplot() + geom_histogram(aes(x=num))
#panel$country_product <- as.factor(paste(panel$iso3c, panel$product_hs))
total_imports <- panel %>%
group_by(iso3c, year) %>%
summarize(total_annual_imports = sum(import_value_hs6, na.rm=T)) %>%
ungroup()
panel <- merge(panel, total_imports)
panel$import_share <- panel$import_value_hs6 / panel$total_annual_imports
panel$import_share_ln <- log(panel$import_share)
panel <- panel %>%
group_by(iso3c_product) %>%
mutate(global_market_share_l1 = lag(global_market_share_hs6, order_by=year, n=1),
coi_l1 = lag(coi_hs6, order_by=year, n=1),
eci_l1 = lag(eci_hs6, order_by=year, n=1),
pci_l1 = lag(pci_hs4, order_by=year, n=1),
elasticity_l1 = lag(elasticity, order_by=year, n=1),
belowinvstgrade_any_l1 = lag(belowinvstgrade_any, order_by=year, n=1),
belowinvstgrade_all_l1 = lag(belowinvstgrade_all, order_by=year, n=1),
import_share_ln_l1 = lag(import_share_ln, order_by=year, n=1)) %>%
ungroup()
panel$import_share_ln_l1[is.infinite(panel$import_share_ln_l1)] <- NA
median_gdp <- panel %>%
group_by(year) %>%
summarize(median_gdppc_const2015usd_ln = median(gdppc_const2015usd_ln, na.rm=T))
panel <- merge(panel, median_gdp, by="year")
panel$below_median_gdp <- panel$gdppc_const2015usd_ln < panel$median_gdppc_const2015usd_ln
panel$global_market_share_ln_l1 <- log(panel$global_market_share_l1)
panel$global_market_share_ln_l1[is.infinite(panel$global_market_share_ln_l1)] <- NA
hist(panel$global_market_share_ln_l1)
panel$mfn_rate_l1_winsor <- DescTools::Winsorize(panel$mfn_rate_l1, quantile(panel$mfn_rate_l1, probs=c(0.05, 0.95), na.rm=T))
panel$mfn_rate_winsor <- DescTools::Winsorize(panel$mfn_rate, quantile(panel$mfn_rate, probs=c(0.05, 0.95), na.rm=T))
panel$reer1_l1_winsor <- DescTools::Winsorize(panel$reer1_l1, quantile(panel$reer1_l1, probs=c(0.05, 0.95), na.rm=T))
#panel$overhang_winsor <- DescTools::Winsorize(panel$overhang, quantile(panel$overhang, probs=c(0.05, 0.95), na.rm=T))
#table(is.na(panel$gdp_const2015usd_ln), panel$year)
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc, na.rm=T),
population_ln = mean(population_ln, na.rm=T))
names(panel)
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc.x, na.rm=T),
population_ln = mean(population_ln, na.rm=T))
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc.x, na.rm=T),
population_ln = mean(population_ln.x, na.rm=T))
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc.x, na.rm=T),
population_ln = mean(population_ln.x, na.rm=T),
OFn_all = mean(OFn_all.x, na.rm=T))
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc.x, na.rm=T),
population_ln = mean(population_ln.x, na.rm=T),
OFn_all = mean(OFn_all.x, na.rm=T),
IV_reserves_OFn_all_1_ln.x=mean(IV_reserves_OFn_all_1_ln.x, na.rm=T),
l3.IV_factor1_OFn_all_1_ln.x=mean(l3.IV_factor1_OFn_all_1_ln.x, na.rm=T))
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc.x, na.rm=T),
population_ln = mean(population_ln.x, na.rm=T),
OFn_all = mean(OFn_all.x, na.rm=T),
IV_reserves_OFn_all_1_ln.x=mean(IV_reserves_OFn_all_1_ln.x, na.rm=T),
IV_factor1_OFn_all_1_ln.x=mean(IV_factor1_OFn_all_1_ln.x, na.rm=T))
table(panel_cy$year)
panel_cy <- panel_cy %>%
group_by(iso3c) %>%
mutate(OFn_all_l2 = lag(OFn_all, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel$yeardiff_l1 <- panel$year - panel$year_l1
panel$yeardiff_l2 <- panel$year - panel$year_l2
panel_cy$yeardiff_l1 <- panel_cy$year - panel_cy$year_l1
panel_cy$yeardiff_l2 <- panel_cy$year - panel_cy$year_l2
panel_cy$yeardiff_l3 <- panel_cy$year - panel_cy$year_l3
panel_cy$yeardiff_l2 <- panel_cy$year - panel_cy$year_l2
panel_cy$yeardiff_l3 <- panel_cy$year - panel_cy$year_l3
table(panel_cy$yeardiff_l2)
panel_cy$OFn_all_l2[which(panel_cy$yeardiff_l2>2)] <- NA
panel_cy$IV_reserves_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
panel_cy$IV_factor1_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
feols(growth_pc ~ population_ln.x_l1 | iso3c + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy)
feols(growth_pc ~ population_ln.x | iso3c + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy)
feols(growth_pc ~ population_ln | iso3c + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy)
panel_cy <- panel_cy %>%
group_by(iso3c) %>%
mutate(OFn_all.x_l2 = lag(OFn_all, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel_cy$yeardiff_l1 <- panel_cy$year - panel_cy$year_l1
panel_cy$yeardiff_l2 <- panel_cy$year - panel_cy$year_l2
panel_cy$yeardiff_l3 <- panel_cy$year - panel_cy$year_l3
panel_cy$OFn_all.x_l2[which(panel_cy$yeardiff_l2>2)] <- NA
panel_cy$IV_reserves_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
panel_cy$IV_factor1_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
feols(growth_pc ~ population_ln | iso3c + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy)
feols(growth_pc ~ population_ln | iso3c + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy, cluster="iso3c")
feols(growth_pc ~ population_ln | iso3c | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy, cluster="iso3c")
hist(panel_cy$IV_reserves_OFn_all_1_ln.x_l3)
feols(growth_pc ~ population_ln + year | iso3c | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy, cluster="iso3c")
feols(growth_pc ~ population_ln + year | iso3c | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy[which(panel_cy$iso3c!="CHN") , ], cluster="iso3c")
panel_cy <- panel_cy %>%
group_by(iso3c) %>%
mutate(OFn_all.x_l2 = lag(OFn_all, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
population_ln_l1 = lag(population_ln, order_by = year, n=1)
year_l3 = lag(year, order_by = year, n=3),
panel_cy <- panel_cy %>%
group_by(iso3c) %>%
mutate(OFn_all.x_l2 = lag(OFn_all, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
population_ln_l1 = lag(population_ln, order_by = year, n=1),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel_cy$yeardiff_l1 <- panel_cy$year - panel_cy$year_l1
panel_cy$yeardiff_l2 <- panel_cy$year - panel_cy$year_l2
panel_cy$yeardiff_l3 <- panel_cy$year - panel_cy$year_l3
panel_cy$population_ln_l1[which(panel_cy$yeardiff_l2>2)] <- NA
panel_cy$OFn_all.x_l2[which(panel_cy$yeardiff_l2>2)] <- NA
panel_cy$IV_reserves_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
panel_cy$IV_factor1_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
feols(growth_pc ~ population_ln_l1 + year | iso3c | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy[which(panel_cy$iso3c!="CHN") , ], cluster="iso3c")
repl <- feols(growth_pc ~ population_ln_l1 + year | iso3c | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy[which(panel_cy$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
summary(repl)
summary(repl$iv_first_stage)
repl$iv_first_stage
summary(repl)
repl$iv_first_stage
summary(repl)
repl$iv_first_stage
hist(panel_cy$year)
panel <- panel %>%
group_by(iso3c_product) %>%
mutate(population_ln_l1 = lag(population_ln, order_by = year, n=1),
gdppc_const2015usd_l1 = lag(gdppc_const2015usd, order_by = year, n=1))
panel <- panel %>%
group_by(iso3c_product) %>%
mutate(population_ln.x_l1 = lag(population_ln.x, order_by = year, n=1),
gdppc_const2015usd_l1 = lag(gdppc_const2015usd, order_by = year, n=1))
panel_cy <- panel_cy %>%
group_by(iso3c) %>%
mutate(OFn_all.x_l2 = lag(OFn_all, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
population_ln_l1 = lag(population_ln, order_by = year, n=1),
gdppc_const2015usd_l1 = lag(gdppc_const2015usd, order_by = year, n=1),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc.x, na.rm=T),
gdppc_const2015usd = mean(gdppc_const2015usd, na.rm=T)
population_ln = mean(population_ln.x, na.rm=T),
panel_cy <- panel %>%
group_by(iso3c, year) %>%
summarize(growth_pc = mean(growth_pc.x, na.rm=T),
gdppc_const2015usd = mean(gdppc_const2015usd, na.rm=T),
population_ln = mean(population_ln.x, na.rm=T),
OFn_all = mean(OFn_all.x, na.rm=T),
IV_reserves_OFn_all_1_ln.x=mean(IV_reserves_OFn_all_1_ln.x, na.rm=T),
IV_factor1_OFn_all_1_ln.x=mean(IV_factor1_OFn_all_1_ln.x, na.rm=T))
panel_cy <- panel_cy %>%
group_by(iso3c) %>%
mutate(OFn_all.x_l2 = lag(OFn_all, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
population_ln_l1 = lag(population_ln, order_by = year, n=1),
gdppc_const2015usd_l1 = lag(gdppc_const2015usd, order_by = year, n=1),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel_cy$yeardiff_l1 <- panel_cy$year - panel_cy$year_l1
panel_cy$yeardiff_l2 <- panel_cy$year - panel_cy$year_l2
panel_cy$yeardiff_l3 <- panel_cy$year - panel_cy$year_l3
panel_cy$gdppc_const2015usd_l1[which(panel_cy$yeardiff_l1>1)] <- NA
panel_cy$population_ln_l1[which(panel_cy$yeardiff_l1>1)] <- NA
panel_cy$OFn_all.x_l2[which(panel_cy$yeardiff_l2>2)] <- NA
panel_cy$IV_reserves_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
panel_cy$IV_factor1_OFn_all_1_ln.x_l3[which(panel_cy$yeardiff_l3>3)] <- NA
repl <- feols(growth_pc ~ population_ln_l1 + year | iso3c | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy[which(panel_cy$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
panel_cy$gdppc_chg <- panel_cy$gdppc_const2015usd - panel_cy$gdppc_const2015usd_l1
repl <- feols(growth_pc ~ population_ln_l1 + year | iso3c + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy[which(panel_cy$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
repl <- feols(growth_pc ~ population_ln_l1 + year | iso3c + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy[which(panel_cy$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
repl$iv_first_stage
panel <- panel %>%
group_by(iso3c_product) %>%
mutate(OFn_all.x_l2 = lag(OFn_all, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
population_ln_l1 = lag(population_ln, order_by = year, n=1),
gdppc_const2015usd_l1 = lag(gdppc_const2015usd, order_by = year, n=1),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel <- panel %>%
group_by(iso3c_product) %>%
mutate(OFn_all.x_l2 = lag(OFn_all.x, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
population_ln_l1 = lag(population_ln, order_by = year, n=1),
gdppc_const2015usd_l1 = lag(gdppc_const2015usd, order_by = year, n=1),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel <- panel %>%
group_by(iso3c_product) %>%
mutate(OFn_all.x_l2 = lag(OFn_all.x, order_by = year, n=2),
IV_reserves_OFn_all_1_ln.x_l3 = lag(IV_reserves_OFn_all_1_ln.x, order_by = year, n=3),
IV_factor1_OFn_all_1_ln.x_l3 = lag(IV_factor1_OFn_all_1_ln.x, order_by = year, n=3),
population_ln_l1 = lag(population_ln.x, order_by = year, n=1),
gdppc_const2015usd_l1 = lag(gdppc_const2015usd, order_by = year, n=1),
year_l3 = lag(year, order_by = year, n=3),
year_l2 = lag(year, order_by = year, n=2),
year_l1 = lag(year, order_by = year, n=1))
panel$yeardiff_l1 <- panel$year - panel$year_l1
panel$yeardiff_l2 <- panel$year - panel$year_l2
panel$yeardiff_l3 <- panel$year - panel$year_l3
panel$gdppc_const2015usd_l1[which(panel$yeardiff_l1>1)] <- NA
panel$population_ln_l1[which(panel$yeardiff_l1>1)] <- NA
panel$OFn_all.x_l2[which(panel$yeardiff_l2>2)] <- NA
panel$IV_reserves_OFn_all_1_ln.x_l3[which(panel$yeardiff_l3>3)] <- NA
panel$IV_factor1_OFn_all_1_ln.x_l3[which(panel$yeardiff_l3>3)] <- NA
repl <- feols(tariffinc_15pct ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
mfn_rate_l1_winsor + v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 | iso3c_product  | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel_cy[which(panel_cy$iso3c!="CHN") , ], cluster="iso3c")
repl <- feols(tariffinc_15pct ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
mfn_rate_l1_winsor + v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 | iso3c_product  | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel[which(panel$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
repl <- feols(tariffinc_15pct ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
mfn_rate_l1_winsor + v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 | iso3c_product  | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel[which(panel$iso3c!="CHN") , ], cluster="iso3c_product")
summary(repl)
repl <- feols(tariffinc_15pct ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
mfn_rate_l1_winsor + v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 | iso3c_product  | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel[which(panel$iso3c!="CHN") , ], cluster="iso3c")
unique(panel$iso3c)
sort(unique(panel$iso3c))
names(panel)
summary(repl)
repl <- feols(tariffinc_15pct ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
mfn_rate_l1_winsor + v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 + eci_l1 + pci_l1 | iso3c_product  | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel[which(panel$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
repl <- feols(overhang ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
mfn_rate_l1_winsor + v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 | iso3c_product | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel[which(panel$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
repl <- feols(overhang ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 | iso3c_product | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel[which(panel$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
repl <- feols(overhang ~ population_ln_l1 + importval_ln_l1 + gdp_const2015usd_ln_l1 + gdppc_const2015usd_ln_l1 +
mfn_rate_l1_winsor + v2x_polyarchy_l1 + reer1_l1_winsor + effective_defacto_regime_v1_l1 | iso3c_product + year | OFn_all.x_l2 ~ IV_reserves_OFn_all_1_ln.x_l3 + IV_factor1_OFn_all_1_ln.x_l3,
data = panel[which(panel$iso3c!="CHN") , ], cluster="iso3c")
summary(repl)
source("~/Documents/GitHub/POL504_precept_2023/Precept9.R", echo=TRUE)
source("~/Documents/GitHub/POL504_precept_2023/Precept9.R", echo=TRUE)
source("~/Documents/GitHub/POL_574_SP25/Precept8.R", echo=TRUE)
help(sim2)
rm(list = ls())
## working directory
setwd("/Users/christianbaehr/Documents/GitHub/POL_574_SP25/data/")
## package dependencies
pacman::p_load(quanteda, quanteda.corpora, dplyr, lsa, factoextra, text2vec, quanteda.textmodels)
## create a corpus of SOTU speeches after 1900
data("data_corpus_sotu")
SOTU <- corpus_subset(data_corpus_sotu, Date > "1900-01-01")
## generate a dfm, remove stopwords, and stem
SOTU_dfm <- tokens(SOTU, remove_punct = T) %>%
dfm() %>%
dfm_remove(stopwords("en")) %>%
dfm_wordstem()
## convert to matrix object
SOTU_mat <- as.matrix(SOTU_dfm)
## only keep complete rows (1)
SOTU_mat <- SOTU_mat[complete.cases(SOTU_mat) , ]
## rescale all variables to be mean-zero with standard deviation of 1
SOTU_mat_normal <- scale(SOTU_mat)
## estimate the principal components of the DFM
SOTU_pca <- prcomp(SOTU_mat_normal)
## estimate the principal components of the DFM
SOTU_pca <- prcomp(SOTU_mat_normal)
## visualize the variance contribution of each component
fviz_eig(SOTU_pca, addlabels = TRUE)
## principal components
SOTU_pca$x
View(SOTU_pca$x)  # each observation
## variable importance for each PC
SOTU_pca$rotation
dim(SOTU_pca$rotation)
## variable importance for each PC
SOTU_pca$rotation
v[,1]
SOTU_pca$rotation[,1]
dim(SOTU_pca$rotation)
## format the components
pr.comps <- data.frame(SOTU_pca$x) # dataframe
pr.comps$party <- as.character(docvars(SOTU_dfm)[ , "party"]) # get party from corpus
pr.comps <- pr.comps[order(pr.comps$PC1), ] # order by PC1 value
pr.comps$order <- 1:nrow(pr.comps)
pr.comps <- pr.comps[order(pr.comps$PC1), ] # order by PC1 value
pr.comps$order <- 1:nrow(pr.comps)
## plot presidents' scores on the first PC
ggplot(pr.comps, aes(x = order, y = PC1, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
## plot presidents' first and second PCs
ggplot(pr.comps, aes(x = PC1, y = PC2, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
## plot presidents' scores on the first PC
ggplot(pr.comps, aes(x = order, y = PC1, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
## plot presidents' first and second PCs
ggplot(pr.comps, aes(x = PC1, y = PC2, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
## plot presidents' first and second PCs
ggplot(pr.comps, aes(x = PC1, y = PC2, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
## plot presidents' scores on the first PC
ggplot(pr.comps, aes(x = order, y = PC1, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
## plot presidents' first and second PCs
ggplot(pr.comps, aes(x = PC1, y = PC2, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
## plot presidents' scores on the first PC
ggplot(pr.comps, aes(x = order, y = PC1, label = rownames(pr.comps), color = party)) +
geom_text(size = 2) +
scale_color_manual(values = c("#013364","#cc0000")) +
theme_bw()
nearest.neighbors <- function(query, low_dim_space, N = 5, norm = "l2"){
cos_sim <- sim2(x = low_dim_space, y = low_dim_space[query, , drop = FALSE], method = "cosine", norm = norm)
nn <- cos_sim <- cos_sim[order(-cos_sim),]
return(names(nn)[2:(N + 1)])  # query is always the nearest neighbor hence dropped
}
## apply to document retrieval
nearest.neighbors(query = "Obama-2009", low_dim_space = SOTU_pca$x)
nearest.neighbors(query = "Reagan-1982", low_dim_space = SOTU_pca$x)
(N + 1)
help(sim2)
## apply to document retrieval
nearest.neighbors(query = "Obama-2009", low_dim_space = SOTU_pca$x, norm = "none")
## apply to document retrieval
nearest.neighbors(query = "Obama-2009", low_dim_space = SOTU_pca$x)
nearest.neighbors(query = "Reagan-1982", low_dim_space = SOTU_pca$x, norm = "none")
nearest.neighbors(query = "Reagan-1982", low_dim_space = SOTU_pca$x)
## apply to document retrieval
nearest.neighbors(query = "Obama-2009", low_dim_space = SOTU_pca$x, norm = "none")
nearest.neighbors(query = "Reagan-1982", low_dim_space = SOTU_pca$x, norm = "none")
## apply to document retrieval
nearest.neighbors(query = "Obama-2009", low_dim_space = SOTU_pca$x)
nearest.neighbors(query = "Reagan-1982", low_dim_space = SOTU_pca$x)
## Let's keep using the SOTU data from before
SOTU_mat_lsa <- convert(SOTU_dfm, to = "lsa") # convert to transposed matrix
SOTU_mat_lsa <- lw_logtf(SOTU_mat_lsa) * gw_idf(SOTU_mat_lsa)
lw_logtf(SOTU_mat_lsa)
gw_idf(SOTU_mat_lsa)
help("lw_logtf")
gw_idf(SOTU_mat_lsa)
help("gw_idf")
SOTU_lsa <- lsa(SOTU_mat_lsa)
class(lw_logtf(SOTU_mat_lsa))
class(gw_idf(SOTU_mat_lsa))
## create LSA weights using TDM
SOTU_lsa <- lsa(SOTU_mat_lsa)
cor(SOTU_lsa$tk[,1], SOTU_lsa$tk[,2])
class(SOTU_lsa)
SOTU_lsa
SOTU_lsa$sk
dim(SOTU_lsa$dk)
dim(SOTU_lsa$tk)
## use five topics
SOTU_lsa_5 <- lsa(SOTU_mat_lsa, 5)
## display generated LSA space
SOTU_lsa_5_mat <- t(as.textmatrix(SOTU_lsa_5))
SOTU_lsa_5_mat
## use five topics
SOTU_lsa_5 <- lsa(SOTU_mat_lsa, 5)
## display generated LSA space
SOTU_lsa_5_mat <- t(as.textmatrix(SOTU_lsa_5))
SOTU_dfm@Dimnames$docs[130]
topfeatures(SOTU_dfm[130,])
## with 5 dims:
sort(SOTU_lsa_5_mat[130,], decreasing=T)[1:10]
SOTU_lsa_mat <- as.textmatrix(SOTU_lsa)
oil <- associate(SOTU_lsa_mat, "oil", "cosine", threshold = .7)
oil[1:10]
health <- associate(SOTU_lsa_mat, "health", "cosine", threshold = .7)
health[1:10]
SOTU_lsa_5$sk
SOTU_lsa$sk
## display generated LSA space
SOTU_lsa_5_mat <- t(as.textmatrix(SOTU_lsa_5))
## what are these documents about?
## compare features for a few speeches
SOTU_dfm@Dimnames$docs[130]
topfeatures(SOTU_dfm[130,])
## with 5 dims:
sort(SOTU_lsa_5_mat[130,], decreasing=T)[1:10]
dim(SOTU_lsa_5_mat)
oil <- associate(SOTU_lsa_mat, "oil", "cosine", threshold = .7)
oil[1:10]
health <- associate(SOTU_lsa_mat, "health", "cosine", threshold = .7)
health[1:10]
SOTU_lsa_5_mat
## what are these documents about?
## compare features for a few speeches
SOTU_dfm@Dimnames$docs[130]
topfeatures(SOTU_dfm[130,])
sort(SOTU_lsa_5_mat[130,], decreasing=T)[1:10]
## use five topics
SOTU_lsa_5 <- lsa(SOTU_mat_lsa, 5)
dim(SOTU_lsa_5)
SOTU_lsa_5
dim(SOTU_lsa_5$tk)
dim(SOTU_lsa_5$dk)
dim(SOTU_lsa_5$sk)
dim(SOTU_lsa_5_mat)
SOTUsort(SOTU_mat_lsa[130,], decreasing=T)[1:10]
sort(SOTU_mat_lsa[130,], decreasing=T)[1:10]
sort(SOTU_mat_lsa[,130], decreasing=T)[1:10]
help("as.textmatrix")
## with 5 dims:
sort(SOTU_lsa_5_mat[130,], decreasing=T)[1:10]
